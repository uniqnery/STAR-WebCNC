================================================================================
         CNC 자동선반 스마트팩토리 시스템 아키텍처 리뷰
================================================================================

문서 버전: 1.7 (2026-01-23)
리뷰 일자: 2026-01-23
리뷰어: 수석 아키텍트

================================================================================
## 1. 지금 반드시 정의(확정)해야 하는 항목
================================================================================

### 1.1 제어권(Control Lock) 상태 관리 위치
--------------------------------------------------------------------------------
| 항목             | 현재 상태      | 필요한 결정                    |
|------------------|----------------|--------------------------------|
| 제어권 상태 저장 | 명시되지 않음  | Server 메모리 vs Redis vs DB   |

[왜 지금 확정해야 하는가]
- 제어권은 모든 제어 기능의 진입점으로, Frontend/Server/Agent가 동시에 의존
- Server 재시작 시 제어권 상태 복구 전략이 달라짐
- 다중 서버 환경 확장 시 분산 락 필요 여부 결정

[확정하지 않을 경우 리스크]
- Server 장애 복구 후 제어권 충돌 발생 가능
- 구현 후 저장소 변경 시 전체 제어 로직 수정 필요

[권장안] Redis 사용 (TTL 기반 자동 만료, 분산 환경 대응)


### 1.2 Agent <-> Server 간 제어 명령 응답 프로토콜
--------------------------------------------------------------------------------
| 항목           | 현재 상태          | 필요한 결정                      |
|----------------|--------------------|----------------------------------|
| 명령 응답 흐름 | MQTT Topic만 정의됨 | 동기/비동기, ACK 방식, 타임아웃  |

[왜 지금 확정해야 하는가]
- 원격제어 모드에서 PMC 쓰기 -> 결과 확인 흐름이 핵심
- 명령 실패 시 Frontend에 어떻게 전달할지 결정 필요
- Server/Agent/Frontend 모두 이 프로토콜에 의존

[확정하지 않을 경우 리스크]
- 각 모듈이 다른 가정으로 구현 -> 통합 시 대규모 수정
- 타임아웃/재시도 정책 불일치로 사용자 경험 저하

[권장안]
  Server -> Agent: MQTT command (QoS 1) + correlation_id
  Agent -> Server: MQTT response (QoS 1) + 같은 correlation_id
  Server 측 타임아웃: 5초 (설정 가능)


### 1.3 인터록 조건 평가 위치 (Agent vs Server)
--------------------------------------------------------------------------------
| 항목        | 현재 상태           | 필요한 결정    |
|-------------|---------------------|----------------|
| 인터록 평가 | "Agent에서 확인" 암시 | 최종 결정 명확화 |

[왜 지금 확정해야 하는가]
- 인터록은 안전 기능으로, 평가 위치가 책임 소재 결정
- Server에서 평가 시: 네트워크 지연으로 안전 위험
- Agent에서 평가 시: Server는 UI 표시용 상태만 수신

[확정하지 않을 경우 리스크]
- 이중 평가로 불일치 발생 (Server는 OK, Agent는 거부)
- 안전 관련 버그 발생 시 책임 소재 불명확

[권장안] Agent에서 최종 평가 (Server는 UI 표시용 캐시만 유지)


### 1.4 인증 토큰 방식
--------------------------------------------------------------------------------
| 항목      | 현재 상태              | 필요한 결정 |
|-----------|------------------------|-------------|
| 인증 방식 | "JWT vs Session?" 미결정 | 확정 필요   |

[왜 지금 확정해야 하는가]
- REST API 설계의 기본 구조 결정
- WebSocket 인증 흐름에 직접 영향
- 보안 관련 미들웨어 구조 결정

[권장안] JWT (Access Token + Refresh Token)
- 이유: WebSocket 재연결 시 토큰 기반 인증 용이, 상태 비저장


### 1.5 데이터베이스 선정
--------------------------------------------------------------------------------
| 항목    | 현재 상태                  | 필요한 결정 |
|---------|----------------------------|-------------|
| DB 종류 | "PostgreSQL vs MySQL?" 미결정 | 확정 필요   |

[왜 지금 확정해야 하는가]
- DB 스키마 설계 착수 전 필수
- ORM/Query Builder 선정에 영향
- 시계열 데이터(POP) 저장 전략 결정

[권장안] PostgreSQL + TimescaleDB 확장
- 이유: 시계열 집계(POP) 최적화, JSON 타입 지원(템플릿 저장)


================================================================================
## 2. 구현 단계에서 점진적으로 정의해도 되는 항목
================================================================================

### 2.1 데이터 수집 주기 (Polling Interval)
--------------------------------------------------------------------------------
| 항목             | 현재 상태        | 권장 결정 시점                      |
|------------------|------------------|-------------------------------------|
| FOCAS 폴링 주기  | 100~500ms 범위 제시 | Phase 2 (실시간 모니터링 구현 시)  |

[지금 확정하지 않아도 되는 이유]
- 실제 장비 부하/응답 시간 측정 후 조정 필요
- Agent 설정값으로 런타임 변경 가능하게 설계하면 됨
- 최적값은 현장 테스트로만 확인 가능


### 2.2 KPI 임계값 (경고/위험 수치)
--------------------------------------------------------------------------------
| 항목            | 현재 상태  | 권장 결정 시점        |
|-----------------|------------|----------------------|
| 가동률 경고/위험 | 수치 미정의 | Phase 4 (POP 구현 시) |

[지금 확정하지 않아도 되는 이유]
- 현장 운영 데이터 기반으로 의미 있는 수치 도출 필요
- Global Settings에서 관리자가 설정 가능하게 구현
- 초기값 제공 후 운영하며 조정


### 2.3 3D 뷰어 라이브러리
--------------------------------------------------------------------------------
| 항목                   | 현재 상태 | 권장 결정 시점     |
|------------------------|-----------|-------------------|
| Three.js vs Babylon.js | 미결정    | Phase 5 (고급 기능) |

[지금 확정하지 않아도 되는 이유]
- Phase 5 항목으로 우선순위 낮음
- 2D 대시보드로 핵심 기능 구현 가능
- 기술 평가 시간 확보 가능


### 2.4 차트 라이브러리
--------------------------------------------------------------------------------
| 항목                  | 현재 상태 | 권장 결정 시점 |
|-----------------------|-----------|----------------|
| Recharts vs Chart.js  | 미결정    | Phase 2 초기   |

[지금 확정하지 않아도 되는 이유]
- 기술 스택에 Recharts 언급됨 (기본값)
- 교체해도 UI 컴포넌트 수준 변경만 필요
- 실제 데이터 시각화 요구사항 파악 후 결정 가능


### 2.5 캐싱 전략 상세
--------------------------------------------------------------------------------
| 항목           | 현재 상태      | 권장 결정 시점 |
|----------------|----------------|----------------|
| Redis 캐시 구조 | 사용 여부만 검토 | Phase 2~3      |

[지금 확정하지 않아도 되는 이유]
- 성능 병목 발생 시점에 도입해도 무방
- 초기에는 Server 메모리 캐시로 충분
- 캐시 무효화 전략은 데이터 흐름 확정 후 설계


================================================================================
## 3. "지금 정하지 말아야 할 것" (조기 확정 금지 항목)
================================================================================

### 3.1 [금지] FOCAS 함수 호출 순서 및 조합
--------------------------------------------------------------------------------
[왜 지금 정하면 안 되는가]
- 실제 CNC 장비 연결 없이 정확한 동작 검증 불가
- FANUC 기종별로 함수 동작 차이 존재 가능
- FOCAS2 라이브러리의 숨겨진 제약조건 파악 필요

[결정 시점] Agent 프로토타입 + 실제 장비 테스트 후


### 3.2 [금지] PMC 주소 매핑 기본값
--------------------------------------------------------------------------------
[왜 지금 정하면 안 되는가]
- 기종별 PMC 주소는 현장 장비 확인 필수
- 잘못된 PMC 주소로 안전 사고 가능
- 템플릿 시스템이 이를 추상화하도록 설계됨

[결정 시점] 대상 장비별 PMC 래더 분석 완료 후


### 3.3 [금지] 스케줄러 대기열 최대 크기 고정
--------------------------------------------------------------------------------
[왜 지금 정하면 안 되는가]
- 10~20개로 범위만 정의됨 (적절함)
- 현장 운영 패턴에 따라 최적값 다름
- 설정 가능하게 두고 운영 데이터로 판단

[결정 시점] 실제 스케줄러 운영 1개월 후


### 3.4 [금지] 제어권 유휴 타임아웃 수치
--------------------------------------------------------------------------------
[왜 지금 정하면 안 되는가]
- "5분" 예시로 제시됨 (고정 아님)
- 현장 작업 패턴 관찰 필요
- 너무 짧으면 불편, 너무 길면 안전 위험

[결정 시점] 베타 운영 후 사용자 피드백 기반


### 3.5 [금지] MES 연동 방향 (내부 생성 vs 외부 연동)
--------------------------------------------------------------------------------
[왜 지금 정하면 안 되는가]
- 고객사 기존 MES 존재 여부에 따라 달라짐
- 연동 인터페이스 표준 파악 필요
- Phase 5 항목으로 충분한 검토 시간 확보

[결정 시점] Phase 4 완료 후, 고객사 요구사항 확정 시


================================================================================
## 4. 아키텍처 고정점 (Freeze Point) 제안
================================================================================

다음 항목들은 이후 변경 시 대규모 수정이 불가피하므로 고정을 권장합니다:

| #  | 항목                                        | 이유                              |
|----|---------------------------------------------|-----------------------------------|
| 1  | 4-Tier 아키텍처 (Frontend/Server/Agent/CNC) | 모든 모듈의 책임 분리 기준        |
| 2  | Agent 1:1 장비 매핑                         | 장비 독립성, 장애 격리의 핵심     |
| 3  | 템플릿 기반 PMC 추상화                      | 다기종 지원의 핵심 메커니즘       |
| 4  | 제어권 단일 점유 모델 (장비당 1명)          | 충돌 방지, 안전 제어의 기반       |
| 5  | 현장 우선 원칙 (원격제어 충돌 시)           | 안전 정책의 근간                  |
| 6  | 인터록 조건 Template 전용 관리              | 안전 설정 무단 변경 방지          |
| 7  | 호기 컨텍스트 기반 UI (좌측 사이드바)       | 전체 UI 네비게이션 구조           |
| 8  | MQTT 기반 Server <-> Agent 통신             | 비동기 메시징 구조                |
| 9  | REST + WebSocket 기반 Frontend <-> Server   | 클라이언트 통신 패턴              |


================================================================================
## 5. 최종 결론
================================================================================

### Q1. 현재 architecture.md는 "지금 구현을 시작해도 되는 수준"인가?
--------------------------------------------------------------------------------
[답변] 조건부 YES

문서 버전 1.7은 핵심 아키텍처 결정이 대부분 완료되었습니다:
  [O] 4-Tier 구조 및 책임 분리 명확
  [O] 메뉴 구조 및 접근 권한 정의 완료
  [O] 제어권 정책 정의 완료
  [O] 원격제어 모드 인터록 정의 완료
  [O] 메시지 스키마 및 API 표준 정의됨
  [O] 데이터 흐름 다이어그램 완성

단, 아래 4개 항목 확정 후 구현 착수를 권장합니다.


### Q2. 어떤 정의가 추가로 끝나야 구현 단계로 넘어가는 것이 안전한가?
--------------------------------------------------------------------------------
| #  | 필수 확정 항목                   | 현재 상태   | 예상 소요 |
|----|----------------------------------|-------------|-----------|
| 1  | 인증 방식 (JWT 확정)             | 미결정      | 1시간     |
| 2  | 데이터베이스 선정 (PostgreSQL)   | 미결정      | 1시간     |
| 3  | 제어권 상태 저장소 (Redis 확정)  | 미결정      | 1시간     |
| 4  | Agent 명령 응답 프로토콜 상세    | 부분 정의   | 2시간     |

총 예상 소요: 반나절


### Q3. 현재 단계의 가장 적절한 다음 액션은 무엇인가?
--------------------------------------------------------------------------------
[권장 순서]

1. [즉시] 4개 미결정 항목 확정 -> architecture.md 반영

2. [1일] DB 스키마 초안 설계
   - 사용자/권한 테이블
   - 장비/템플릿 테이블
   - 이력/로그 테이블

3. [2-3일] Agent 프로토타입 개발
   - FOCAS2 연결 테스트
   - 기본 PMC 읽기/쓰기 검증
   - MQTT 통신 검증

4. [병렬] Frontend 프로젝트 초기 설정
   - React + Vite + TypeScript 셋업
   - 라우팅/상태관리 기본 구조

5. [병렬] Server 프로젝트 초기 설정
   - Express + TypeScript 셋업
   - JWT 인증 미들웨어
   - WebSocket/MQTT 기본 연결


### 종합 평가
--------------------------------------------------------------------------------
| 평가 항목        | 점수  | 비고                     |
|------------------|-------|--------------------------|
| 아키텍처 완성도  | 4/5   | 핵심 구조 확정됨         |
| 인터페이스 정의  | 4/5   | API/메시지 표준 있음     |
| 안전 설계        | 5/5   | 인터록/제어권 상세함     |
| 구현 준비도      | 3/5   | 일부 기술 결정 필요      |
| 확장성 고려      | 4/5   | 템플릿/Agent 구조 우수   |


================================================================================
[결론]
================================================================================
architecture.md v1.7은 구현 착수 직전 단계입니다.
위 4개 항목만 확정하면 Phase 1 개발을 시작할 수 있습니다.

================================================================================
                              리뷰 완료: 2026-01-23
================================================================================
