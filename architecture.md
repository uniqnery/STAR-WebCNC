# CNC 자동선반 스마트팩토리 시스템 아키텍처

## 1. 시스템 개요

### 1.1 프로젝트 목적
FANUC CNC 자동선반을 웹 기반으로 모니터링하고 제한적 원격 제어를 수행하는 스마트팩토리 시스템 구축

### 1.2 시스템 범위
- **모니터링**: 장비 상태, 알람, 생산 현황 실시간 확인
- **제한적 원격 제어**: 스케줄러를 통한 프로그램 실행 (직접 NC 조작 불가)
- **POP/MES 연계**: 생산실적 집계, 작업지시 관리
- **데이터 관리**: 프로그램 전송, 백업, 이력 관리

### 1.3 대상 장비
- FANUC CNC 자동선반
- FOCAS2 라이브러리를 통한 통신

### 1.4 사용자 유형 및 권한

| 구분 | 역할 | 주요 권한 |
|------|------|-----------|
| 일반 사용자 | 모니터링 전용 | 대시보드 조회, 장비 상태 확인 |
| 관리자 (Admin) | 운영 관리 | 스케줄러 실행, 설정 변경, Transfer |
| AS 담당자 | 시스템 유지보수 | 템플릿 관리, 전체 설정 접근 |

### 1.5 메뉴 접속도

#### 1.5.1 로고 및 호기 컨텍스트 배치 원칙

- **로고 및 호기 선택기 위치**: **좌측 사이드바(메뉴바) 최상단**에 고정 배치
- **제어/사용자 버튼 노출 정책**:
  - **제어실행요청** 및 **로그인 사용자 표시**는 제어가 수반되는 특정 화면에서만 상단 바(Header)에 표시
  - 대상 화면: **Operation Panel**, **Scheduler**
  - 그 외 화면(Dashboard, Transfer, POP/MES 등)에서는 숨김 처리

- **호기 선택 동작 원칙**:
  - 사용자가 어떤 화면을 보고 있든, 호기를 변경하면 **현재 화면은 유지**하고 **선택된 호기의 데이터로 갱신**
  - 호기 선택은 "페이지 이동 트리거"가 아니라 **"데이터 컨텍스트"** 역할

```
┌──────────────────────────────────────┐ ┌────────────────────────────────────┐
│ [메뉴바 상단]                        │ │ [화면 상단 바 (Header)]            │
│  [STAR 로고]                         │ │ (Op.Panel / Scheduler 전용)        │
│  [▼ 1호기 자동선반 (드롭다운)]       │ │           [제어실행요청] [사용자]  │
└──────────────────────────────────────┘ └────────────────────────────────────┘
```

#### 1.5.2 메뉴 구조 및 접속도

```
[ 접속 URL ]
     │
     ▼
[ 로그인 ]
  ├─ 회원가입 (관리자 코드 / 관리자 승인 필요)
  └─ 승인된 사용자만 로그인 가능
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 메인 대시보드 (로그인 후 첫 화면)                [모든 사용자 접근]  │
│ ─────────────────────────────────────────────────────────────────── │
│ ┌────────────────────────────────────────────────────────────────┐  │
│ │ [STAR 로고] [▼ 호기 선택]              [제어실행요청] [사용자] │  │
│ ├────────────────────────────────────────────────────────────────┤  │
│ │  상단: 공장 전체 가동현황 / 생산 KPI                           │  │
│ ├────────────────────────────────────────────────────────────────┤  │
│ │  메인: 공장 레이아웃 (2D / 3D 선택)                           │  │
│ │       · 장비 상태 색상 표시 (가동/대기/알람/오프)             │  │
│ │       · 실시간 가동 현황 한눈에 확인                          │  │
│ │       · 장비 클릭 → 해당 장비 호기 선택 + Operation Panel     │  │
│ └────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
     │
     ├─────────────────────────────────────────────────────────────────┐
     │                                                                 │
[ 좌측 메뉴 구조 (Machine 중심 내비게이션) ]                           │
├────────────────────────────────────────────────────────────────────  │
│                                                                      │
├─ [ Dashboard ]                              [모든 사용자]            │
│   └─ 공장 전체 현황 (상단 KPI + 하단 2D/3D 레이아웃)                 │
│                                                                      │
├─ [ Machines 메뉴 ] ─────────────────────────────────────────────────│
│   │                                                                  │
│   ├─ [ Operation Panel ]                    [모든 사용자]            │
│   │       │                                                          │
│   │       ▼                                                          │
│   │   ┌─────────────────────────────────────────────┐                │
│   │   │ Operation Panel (2분할 레이아웃)             │                │
│   │   │ ─────────────────────────────────────────── │                │
│   │   │ [좌측: CNC 모니터 영역]  [우측: 기계 조작반 영역] │                │
│   │   │ · 프로그램 정보          · 모드 선택 (EDIT,   │                │
│   │   │ · 모달 / 좌표계          │ MEM, MDI 등)       │                │
│   │   │ · 스핀들 RPM/부하        · 조작 버튼류        │                │
│   │   │ · 실시간 상태 모니터링   · 오버라이드 다이얼  │                │
│   │   └─────────────────────────────────────────────┘                │
│   │                                                                  │
│   ├─ [ Scheduler ]                          [관리자/AS 전용]         │
│   │       │                                                          │
│   │       ▼                                                          │
│   │   ┌─────────────────────────────────────────────┐                │
│   │   │ 스케줄러 (2분할 레이아웃)                   │                │
│   │   │ ─────────────────────────────────────────── │                │
│   │   │ ┌─────────────────────────────────────────┐ │                │
│   │   │ │ 인터록 상태 바 (상단)                   │ │                │
│   │   │ │ [도어][척][스핀들][쿨런트]              │ │                │
│   │   │ └─────────────────────────────────────────┘ │                │
│   │   │ ┌──────────────────┬──────────────────────┐ │                │
│   │   │ │ FOCAS 실시간     │ 스케줄러 테이블      │ │                │
│   │   │ │ 데이터 표시      │ Main/Sub PGM         │ │                │
│   │   │ │ ────────────     │ PRESET/COUNT         │ │                │
│   │   │ │ · 좌표계         │ ──────────────────   │ │                │
│   │   │ │ · 스핀들         │ O0001 | 50 | 0/100   │ │                │
│   │   │ │ · 이송 속도      │ O0002 | 30 | 0/50    │ │                │
│   │   │ │ · 프로그램명     │ ...                  │ │                │
│   │   │ └──────────────────┴──────────────────────┘ │                │
│   │   │ [시작] [정지] [리셋] [삭제]                 │                │
│   │   │ ※ 제어권 획득 필요 (우측 상단 제어실행요청)│                │
│   │   └─────────────────────────────────────────────┘                │
│   │                                                                  │
│   ├─ [ Transfer ]                           [관리자/AS 전용]         │
│   │       │                                                          │
│   │       ▼                                                          │
│   │   ┌─────────────────────────────────────────────┐                │
│   │   │ Transfer (선택된 호기)                      │                │
│   │   │ ─────────────────────────────────────────── │                │
│   │   │ · 프로그램 INPUT (서버 → CNC)               │                │
│   │   │ · 프로그램 OUTPUT (CNC → 서버)              │                │
│   │   │ · 전체 백업 (SRAM/파라미터/OFFSET)          │                │
│   │   │ · 백업 이력 조회                            │                │
│   │   │ ─────────────────────────────────────────── │                │
│   │   │ ※ 제어권 없이도 실행 가능 (권한만 필요)    │                │
│   │   │ ※ 가동 중: 백업만 허용, INPUT/OUTPUT 제한  │                │
│   │   │ ※ 복원은 원격 불가 (로컬 Agent에서만)      │                │
│   │   └─────────────────────────────────────────────┘                │
│   │                                                                  │
│   ├─ [ POP (장비별) ]                       [모든 사용자]            │
│   │   └─ 선택된 호기의 생산 실적/분석                                │
│   │                                                                  │
│   └─ [ MES (장비별) ]                       [모든 사용자 조회]       │
│       └─ 선택된 호기에 배정된 작업지시                               │
│                                                                      │
├─ [ POP 메뉴 (전체) ]                        [모든 사용자]            │
│        │                                                             │
│        ▼                                                             │
│   ┌─────────────────────────────────────────────┐                    │
│   │ POP (공장 전체 집계)                        │                    │
│   │ ─────────────────────────────────────────── │                    │
│   │ · 일/주/월별 생산량 그래프                  │                    │
│   │ · KPI 카드 (가동률, OEE, 생산량)            │                    │
│   │ · 장비별 성과 비교 차트                     │                    │
│   │ · 알람 이력 조회                            │                    │
│   │ · 프로그램 실행 이력                        │                    │
│   └─────────────────────────────────────────────┘                    │
│                                                                      │
├─ [ MES 메뉴 (전체) ]                        [모든 사용자 조회 / 관리자 편집]
│        │                                                             │
│        ▼                                                             │
│   ┌─────────────────────────────────────────────┐                    │
│   │ MES (전체 작업지시 목록)                    │                    │
│   │ ─────────────────────────────────────────── │                    │
│   │ · 작업지시 목록 조회                        │                    │
│   │ · 작업지시 생성/수정           [관리자/AS]  │                    │
│   │ · 생산 이력 추적                            │                    │
│   │ · LOT 번호 기반 추적성                      │                    │
│   └─────────────────────────────────────────────┘                    │
│                                                                      │
└─ [ 관리 메뉴 ]                              [관리자/AS 전용]         │
         │
         ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │ 설정/관리                                                       │
    │ ─────────────────────────────────────────────────────────────── │
    │                                                                 │
    │ ┌─────────────────────────────────────────────────────────────┐ │
    │ │ [사용자 관리]                            [관리자/AS]        │ │
    │ │  · 회원가입 승인/거부                                       │ │
    │ │  · 사용자 권한 변경                                         │ │
    │ │  · 사용자 목록 조회                                         │ │
    │ └─────────────────────────────────────────────────────────────┘ │
    │                                                                 │
    │ ┌─────────────────────────────────────────────────────────────┐ │
    │ │ [전역 설정 (Global Settings)]            [관리자/AS]        │ │
    │ │  · POP 계산 공식 (가동률, OEE)                              │ │
    │ │  · KPI 표시 설정 (대시보드 항목, 갱신주기)                  │ │
    │ │  · 시스템 기본값 (스케줄러 모드, 데이터 보관기간)           │ │
    │ │  · 알림 설정 (경고 임계값)                                  │ │
    │ └─────────────────────────────────────────────────────────────┘ │
    │                                                                 │
    │ ┌─────────────────────────────────────────────────────────────┐ │
    │ │ [장비 관리 (Machine Management)]         [관리자/AS]        │ │
    │ │                                                             │ │
    │ │  ┌─ [장비 목록] ─────────────────────────────────────────┐  │ │
    │ │  │  · 등록된 장비 리스트                                 │  │ │
    │ │  │  · 장비 상태 (온라인/오프라인)                        │  │ │
    │ │  │  · 장비 클릭 → 개별 설정 페이지                       │  │ │
    │ │  └───────────────────────────────────────────────────────┘  │ │
    │ │                                                             │ │
    │ │  ┌─ [+ 장비 추가] ───────────────────────────────────────┐  │ │
    │ │  │  Step 1. 템플릿 선택 (기종 선택)                      │  │ │
    │ │  │          └─ 템플릿 목록에서 선택                      │  │ │
    │ │  │  Step 2. 기본 정보 입력                               │  │ │
    │ │  │          └─ 장비명, 장비 ID                           │  │ │
    │ │  │  Step 3. 연결 설정                                    │  │ │
    │ │  │          └─ IP 주소, 포트, 타임아웃, 재시도 횟수      │  │ │
    │ │  │  Step 4. 운영 설정                                    │  │ │
    │ │  │          └─ 스케줄러 모드, 네트워크 폴더 경로         │  │ │
    │ │  │  [등록 완료]                                          │  │ │
    │ │  └───────────────────────────────────────────────────────┘  │ │
    │ │                                                             │ │
    │ │  ┌─ [장비 개별 설정] (장비 선택 시) ─────────────────────┐  │ │
    │ │  │  · 기본 정보 수정 (장비명)                            │  │ │
    │ │  │  · 연결 설정 변경 (IP, 포트, 타임아웃)                │  │ │
    │ │  │  · 템플릿 변경 (버전 업그레이드 등)                   │  │ │
    │ │  │  · 스케줄러 모드 변경                                 │  │ │
    │ │  │  · 네트워크 폴더 경로 변경                            │  │ │
    │ │  │  · [장비 삭제] (확인 팝업)                            │  │ │
    │ │  └───────────────────────────────────────────────────────┘  │ │
    │ └─────────────────────────────────────────────────────────────┘ │
    │                                                                 │
    │ ┌─────────────────────────────────────────────────────────────┐ │
    │ │ [템플릿 관리 (Template Management)]      [AS 전용]          │ │
    │ │  · 템플릿 목록 조회                                         │ │
    │ │  · 템플릿 생성/수정/삭제                                    │ │
    │ │  · PMC 주소 매핑 정의                                       │ │
    │ │  · 인터록 조건 설정 ← 여기서만 수정 가능                    │ │
    │ │  · 템플릿 버전 관리                                         │ │
    │ │  · 템플릿 사용 현황 (어떤 장비가 사용 중인지)               │ │
    │ └─────────────────────────────────────────────────────────────┘ │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘

장비 추가 흐름 상세:
┌─────────────────────────────────────────────────────────────────────┐
│ [+ 장비 추가] 클릭                                                  │
│      │                                                              │
│      ▼                                                              │
│ ┌─────────────────────────────────────────┐                         │
│ │ Step 1. 템플릿 선택                     │                         │
│ │ ┌─────────────────────────────────────┐ │                         │
│ │ │ ○ FANUC 0i-TF 자동선반 (v2.0)      │ │                         │
│ │ │ ○ FANUC 30i-B 자동선반 (v1.5)      │ │                         │
│ │ │ ○ FANUC 0i-TF Plus (v1.0)          │ │                         │
│ │ └─────────────────────────────────────┘ │                         │
│ │                           [다음 →]      │                         │
│ └─────────────────────────────────────────┘                         │
│      │                                                              │
│      ▼                                                              │
│ ┌─────────────────────────────────────────┐                         │
│ │ Step 2. 기본 정보                       │                         │
│ │ ─────────────────────────────────────── │                         │
│ │ 장비 ID:   [ MC-001          ]          │                         │
│ │ 장비명:   [ 1호기 자동선반    ]          │                         │
│ │ 설치 위치: [ A동 1라인        ]          │                         │
│ │                    [← 이전] [다음 →]    │                         │
│ └─────────────────────────────────────────┘                         │
│      │                                                              │
│      ▼                                                              │
│ ┌─────────────────────────────────────────┐                         │
│ │ Step 3. 연결 설정                       │                         │
│ │ ─────────────────────────────────────── │                         │
│ │ IP 주소:     [ 192.168.1.100 ]          │                         │
│ │ 포트:        [ 8193          ]          │                         │
│ │ 타임아웃(ms): [ 3000          ]          │                         │
│ │ 재시도 횟수:  [ 3             ]          │                         │
│ │            [연결 테스트]                 │                         │
│ │                    [← 이전] [다음 →]    │                         │
│ └─────────────────────────────────────────┘                         │
│      │                                                              │
│      ▼                                                              │
│ ┌─────────────────────────────────────────┐                         │
│ │ Step 4. 운영 설정                       │                         │
│ │ ─────────────────────────────────────── │                         │
│ │ 스케줄러 모드: ○ 수동  ● 자동           │                         │
│ │ 최대 대기열:   [ 15           ]          │                         │
│ │ ─────────────────────────────────────── │                         │
│ │ 네트워크 폴더:                          │                         │
│ │  INPUT:  [ \\server\cnc\input  ]        │                         │
│ │  OUTPUT: [ \\server\cnc\output ]        │                         │
│ │  BACKUP: [ \\server\cnc\backup ]        │                         │
│ │                    [← 이전] [등록 완료]  │                         │
│ └─────────────────────────────────────────┘                         │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.6 역할별 메뉴 접근 권한 요약

#### 1.6.1 권한 없는 메뉴 표시 정책

- **모든 메뉴는 항상 표시**한다 (권한과 무관)
- 권한이 없는 메뉴는 **Disabled 스타일**(색상 흐리게, 클릭 불가)로 처리
- 서버에서도 **인가 검증**(403 Forbidden)으로 UI 우회 접근 차단
- 사용자는 시스템의 전체 구조를 파악할 수 있으나, 권한 없는 기능은 사용 불가

#### 1.6.2 메뉴별 권한표

| 메뉴 | 일반 사용자 | 관리자 (Admin) | AS 담당자 |
|------|:-----------:|:--------------:|:---------:|
| **Dashboard** | ✅ 조회 | ✅ 조회 | ✅ 조회 |
| **Machines > Operation Panel** | ✅ 조회 | ✅ 조회 | ✅ 조회 |
| **Machines > Scheduler** | ⛔ 표시만 | ✅ 조회 + 제어* | ✅ 전체 |
| **Machines > Transfer** | ⛔ 표시만 | ✅ INPUT/OUTPUT/백업 | ✅ 전체 |
| **Machines > POP (장비별)** | ✅ 조회 | ✅ 조회 | ✅ 조회 |
| **Machines > MES (장비별)** | ✅ 조회 | ✅ 조회 | ✅ 조회 |
| **POP (전체)** | ✅ 조회 | ✅ 조회 | ✅ 조회 |
| **MES (전체)** | ✅ 조회 | ✅ 조회 + 편집 | ✅ 전체 |
| **사용자 관리** | ⛔ 표시만 | ✅ 승인/권한변경 | ✅ 전체 |
| **전역 설정** | ⛔ 표시만 | ✅ 수정 | ✅ 수정 |
| **장비 설정** | ⛔ 표시만 | ✅ 수정 | ✅ 수정 |
| **템플릿 관리** | ⛔ 표시만 | ⛔ 표시만 | ✅ 전체 |

> **\*제어 권한 주의**: 스케줄러 시작/정지/리셋 등 제어 기능은 **제어권(원격제어 허가) 획득 후** 실행 가능 (섹션 9.3 참조)

---

## 2. 전체 아키텍처 구성

### 2.1 4-Tier 아키텍처

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Frontend (Web UI)                           │
│                    React + TypeScript + Vite                        │
│              Zustand (상태관리) + TailwindCSS (스타일)               │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ REST API / WebSocket
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Central Server (Backend)                        │
│                    Node.js + Express + TypeScript                    │
│           MQTT Broker 연결 / WebSocket 서버 / REST API               │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ MQTT Protocol
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       Field Agent (Edge)                             │
│                         C# .NET 8 Worker                             │
│              FOCAS2 P/Invoke / 장비별 1:1 배치                        │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ FOCAS2 Library (Ethernet/HSSB)
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           CNC Controller                             │
│                    FANUC CNC (0i-TF, 30i 등)                         │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 각 계층별 책임

#### Frontend (Web UI)
- **기술 스택**: React 18 + TypeScript + Vite + Zustand + TailwindCSS + Recharts
- **책임 범위**:
  - 사용자 인터페이스 렌더링
  - WebSocket을 통한 실시간 데이터 수신 및 표시
  - REST API를 통한 명령 요청
  - 로컬 상태 관리 (Zustand)
- **비책임 범위**:
  - 비즈니스 로직 수행
  - 직접적인 장비 통신

#### Central Server (Backend)
- **기술 스택**: Node.js + Express + TypeScript + MQTT Client + WebSocket Server
- **책임 범위**:
  - REST API 제공 (명령 수신, 설정 관리)
  - WebSocket 서버 운영 (클라이언트 실시간 푸시)
  - MQTT Broker와의 통신 (Agent 데이터 수신/명령 전송)
  - 데이터베이스 연동 (설정, 이력, 생산실적)
  - 인증/인가 처리
- **비책임 범위**:
  - FOCAS 직접 통신 (Agent 역할)
  - 하드웨어 수준 제어

#### Field Agent (Edge)
- **기술 스택**: C# .NET 8 Worker Service + FOCAS2 P/Invoke
- **책임 범위**:
  - FOCAS2 라이브러리를 통한 CNC 직접 통신
  - 실시간 데이터 수집 (좌표, 모달, 알람, 카운터 등)
  - PMC 신호 읽기/쓰기
  - 템플릿 기반 데이터 추상화
  - MQTT를 통한 Server 통신
  - **로컬 캐싱을 통한 오프라인 동작 지원**
- **배치 방식**: 장비당 1개 Agent (1:1 매핑)

#### Field Agent 로컬 캐싱 전략
**목적**: Server 장애 시에도 Agent가 독립적으로 동작할 수 있도록 함

**캐싱 방식**: JSON 파일 + 버전 체크
```
Agent 설치 폴더/
├── cache/
│   ├── template_{templateId}.json    # 템플릿 캐시
│   ├── machine_config.json           # 장비 설정 캐시
│   └── cache_meta.json               # 캐시 메타정보 (버전, 갱신일시)
```

**동작 흐름**:
```
Agent 시작
    │
    ▼
Server 연결 시도
    │
    ├─[성공]→ 템플릿 버전 비교
    │             │
    │         ├─[신규 버전]→ 다운로드 → 로컬 캐시 갱신 → 동작 시작
    │         └─[동일 버전]→ 로컬 캐시 사용 → 동작 시작
    │
    └─[실패]→ 로컬 캐시 존재?
                  │
              ├─[있음]→ 로컬 캐시 사용 → 동작 시작 (오프라인 모드)
              └─[없음]→ 시작 실패 → 재시도 대기
```

**캐시 정책**:
- 캐시 유효기간: 무제한 (버전 기반 갱신)
- Server 복구 시: 자동으로 버전 체크 후 필요 시 갱신
- 오프라인 모드: 모니터링만 가능, 명령 전송 불가 (Server 경유 필요)

#### CNC Controller
- FANUC CNC 컨트롤러
- FOCAS2 프로토콜 지원
- Ethernet 또는 HSSB 연결

### 2.3 통신 프로토콜

| 구간 | 프로토콜 | 용도 |
|------|----------|------|
| Frontend ↔ Server | REST API | 명령 전송, 설정 조회/변경 |
| Frontend ↔ Server | WebSocket | 실시간 데이터 푸시 |
| Server ↔ Agent | MQTT | 양방향 메시지 (상태/명령) |
| Agent ↔ CNC | FOCAS2 | 장비 직접 통신 |

### 2.4 메시지 스키마 및 API 표준

#### 2.4.1 REST API 응답 표준

모든 REST API는 아래 형식을 따름:

```typescript
// 성공 응답
interface ApiSuccessResponse<T> {
  success: true;
  data: T;
  timestamp: string;              // ISO 8601 형식
}

// 실패 응답
interface ApiErrorResponse {
  success: false;
  error: {
    code: string;                 // 에러 코드 (예: "INTERLOCK_VIOLATION")
    message: string;              // 사용자 표시용 메시지
    details?: object;             // 상세 정보 (디버깅용)
  };
  timestamp: string;
}

// 에러 코드 예시
// - AUTH_REQUIRED: 인증 필요
// - AUTH_FORBIDDEN: 권한 없음
// - INVALID_REQUEST: 잘못된 요청
// - INTERLOCK_VIOLATION: 인터록 조건 불충족
// - MACHINE_OFFLINE: 장비 오프라인
// - FOCAS_ERROR: FOCAS 통신 오류
// - SCHEDULER_BUSY: 스케줄러 실행 중
// - CONTROL_LOCKED: 다른 사용자가 제어권 보유 중 (현재 제어자 정보 포함)
// - LOCK_REQUIRED: 제어권 획득 필요
// - LOCK_INTERLOCK_FAIL: 제어권 획득 실패 (인터록 조건 불충족)
// - TRANSFER_DENIED_RUNNING: 가동 중 Transfer 제한 (백업만 허용)
```

#### 2.4.2 WebSocket 메시지 표준

```typescript
// WebSocket 메시지 공통 구조
interface WebSocketMessage<T> {
  type: WebSocketMessageType;
  machineId?: string;             // 장비 관련 메시지인 경우
  payload: T;
  timestamp: string;
}

// 메시지 타입
type WebSocketMessageType =
  | 'MACHINE_STATUS'              // 장비 상태 업데이트
  | 'ALARM'                       // 알람 발생/해제
  | 'SCHEDULER_UPDATE'            // 스케줄러 상태 변경
  | 'TRANSFER_PROGRESS'           // 전송 진행률
  | 'CONNECTION_STATUS'           // 연결 상태 변경
  | 'NOTIFICATION';               // 일반 알림

// 장비 상태 메시지 예시
interface MachineStatusPayload {
  coordinates: {
    absolute: { x: number; y: number; z: number };
    machine: { x: number; y: number; z: number };
    relative: { x: number; y: number; z: number };
  };
  spindle: {
    rpm: number;
    load: number;
  };
  feedRate: number;
  operationMode: 'MEM' | 'MDI' | 'JOG' | 'REF' | 'EDIT';
  programNumber: string;
  alarmActive: boolean;
  interlock: Record<string, boolean>;  // 인터록 상태
}
```

#### 2.4.3 MQTT 토픽 구조

```
machines/{machineId}/status      # 장비 상태 (Agent → Server)
machines/{machineId}/command     # 명령 전송 (Server → Agent)
machines/{machineId}/response    # 명령 응답 (Agent → Server)
machines/{machineId}/alarm       # 알람 이벤트

system/agents/{agentId}/health   # Agent 헬스체크
system/broadcast                 # 전체 브로드캐스트
```

**MQTT 메시지 QoS 정책**:
| 토픽 | QoS | 이유 |
|------|-----|------|
| status | 0 | 실시간 데이터, 유실 허용 |
| command | 1 | 명령은 최소 1회 전달 보장 |
| response | 1 | 응답 유실 방지 |
| alarm | 2 | 알람은 정확히 1회 전달 |

---

## 3. 설정 아키텍처 (Global / Machine / Template)

### 3.1 3-Level 설정 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Global Settings (전역 설정)                     │
│                    시스템 공통 설정, 기본값 정의                      │
│                         관리자 권한 필요                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 상속 (기본값 제공)
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Machine Settings (장비별 설정)                    │
│                  개별 장비의 운영 설정 (IP, 모드 등)                  │
│                         관리자 권한 필요                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 참조 (template_id)
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Template Settings (템플릿 설정)                   │
│                   PMC 주소 매핑, 장비 모델 정의                       │
│                        AS 담당자 권한 필요                           │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Global Settings (전역 설정)

**목적**: 시스템 전체에 적용되는 공통 설정값 관리

**주요 항목**:
```typescript
interface GlobalSettings {
  // POP 계산 공식
  pop: {
    utilizationFormula: string;      // 예: "(runTime / totalTime) * 100"
    oeeFormula: string;              // 가동률 × 성능 × 품질
    targetOEE: number;               // 목표 OEE (예: 85)
  };

  // KPI 표시 설정
  kpi: {
    displayMetrics: string[];        // 대시보드 표시 항목
    refreshInterval: number;         // 갱신 주기 (ms)
    alertThresholds: {
      utilizationWarning: number;    // 가동률 경고 임계값
      utilizationCritical: number;   // 가동률 위험 임계값
    };
  };

  // 시스템 기본값
  defaults: {
    schedulerMode: 'manual' | 'auto';
    interlockEnabled: boolean;
    dataRetentionDays: number;       // 이력 보관 기간
  };
}
```

### 3.3 Machine Settings (장비별 설정)

**목적**: 개별 장비의 운영 파라미터 관리

**주요 항목**:
```typescript
interface MachineSettings {
  machineId: string;
  machineName: string;
  templateId: string;                // 참조할 템플릿 ID

  // 통신 설정
  connection: {
    ipAddress: string;
    port: number;
    timeout: number;
    retryCount: number;
  };

  // 스케줄러 설정
  scheduler: {
    mode: 'manual' | 'auto';         // 수동/자동 모드
    maxQueueSize: number;            // 최대 대기열 (10~20)
  };

  // 네트워크 폴더 (Transfer용)
  networkFolder: {
    inputPath: string;               // 프로그램 입력 경로
    outputPath: string;              // 프로그램 출력 경로
    backupPath: string;              // 백업 저장 경로
  };

  // 인터록은 Template에서만 정의 (Machine에서 수정 불가)
  // → 섹션 4.2 Template Settings 참조
}

// ※ 인터록 설정은 Machine Settings에서 제외됨
// - 안전 관련 설정은 AS 담당자만 Template에서 관리
// - 일반 사용자/관리자는 인터록 조건 변경 불가
```

### 3.4 Template Settings (템플릿 설정)

**목적**: 장비 모델별 PMC 주소 매핑 정의 (다음 섹션에서 상세 설명)

### 3.5 설정 계층 간 관계

```
Global Settings          Machine Settings         Template Settings
─────────────────       ─────────────────        ─────────────────
schedulerMode: auto  →  mode: manual (재정의)
                        templateId: "FANUC_0iTF" → PMC 주소 매핑 참조
interlockEnabled: true → enabled: true
                        conditions: {...}        → PMC 주소로 변환
```

**원칙**:
- Global → Machine: Machine에서 재정의 가능 (상속)
- Machine → Template: 참조 관계 (1:N 가능, 여러 Machine이 같은 Template 사용)
- Template: PMC 주소만 정의 (운영 설정 없음)

---

## 4. 장비 템플릿 아키텍처

### 4.1 템플릿의 역할

**문제 상황**:
- 동일 FANUC 시스템이라도 기종/옵션에 따라 PMC 주소가 다름
- 장비마다 PMC 주소를 개별 설정하면 관리 불가
- 새 장비 추가 시 모든 PMC 매핑을 다시 정의해야 함

**해결 방안**:
- 템플릿이 "논리적 신호명 → PMC 주소" 매핑을 정의
- Machine은 템플릿을 참조하여 PMC 주소 획득
- 동일 기종은 동일 템플릿 공유

### 4.2 템플릿 데이터 구조

```typescript
interface EquipmentTemplate {
  // 메타데이터
  templateId: string;                // 고유 식별자 (예: "FANUC_0iTF_v2")
  version: string;                   // 버전 (SemVer)
  name: string;                      // 표시명 (예: "FANUC 0i-TF 자동선반")
  description: string;
  createdAt: Date;
  updatedAt: Date;
  createdBy: string;                 // AS 담당자 ID

  // 시스템 정보
  systemInfo: {
    cncType: 'FANUC' | 'MITSUBISHI' | 'SIEMENS';
    seriesName: string;              // 예: "0i-TF", "30i-B"
    supportedOptions: string[];       // 예: ["PMC-SA1", "Dual Check Safety"]
  };

  // 인터록 설정 (Template 전용 - 사용자 수정 불가)
  interlockConfig: {
    // 인터록 조건 정의 (AS 담당자만 설정 가능)
    conditions: InterlockCondition[];
    // 전체 인터록 활성화 여부
    enabled: boolean;
  };

  // PMC 주소 매핑 (핵심)
  pmcMap: {
    // 인터록 신호
    interlock: {
      doorClosed: PMCAddress;        // 도어 닫힘
      chuckClamped: PMCAddress;      // 척 클램프
      spindleStopped: PMCAddress;    // 스핀들 정지
      coolantLevel: PMCAddress;      // 쿨런트 잔량
      // ...
    };

    // 상태 신호
    status: {
      operationMode: PMCAddress;     // 운전 모드 (MEM/MDI/JOG 등)
      cycleRunning: PMCAddress;      // 사이클 실행 중
      alarmActive: PMCAddress;       // 알람 발생
      programEnd: PMCAddress;        // 프로그램 종료 (M30 신호)
      // ...
    };

    // 제어 신호 (출력)
    control: {
      cycleStart: PMCAddress;        // 사이클 스타트
      feedHold: PMCAddress;          // 피드 홀드
      singleBlock: PMCAddress;       // 싱글 블록
      // ...
    };

    // 카운터/데이터
    counters: {
      partCount: PMCAddress;         // 생산 카운터
      targetCount: PMCAddress;       // 목표 수량
      cycleTime: PMCAddress;         // 사이클 타임
      // ...
    };
  };

  // 지원 기능 플래그
  capabilities: {
    hasSubSpindle: boolean;
    hasCAxisIndexing: boolean;
    hasYAxis: boolean;
    // ...
  };
}

interface PMCAddress {
  type: 'X' | 'Y' | 'G' | 'F' | 'R' | 'D' | 'K' | 'A' | 'C' | 'T';
  address: number;
  bit?: number;                      // 비트 주소 (0-7)
  dataType: 'bit' | 'byte' | 'word' | 'dword';
}

// 인터록 조건 정의 (Template 전용)
interface InterlockCondition {
  id: string;                        // 조건 식별자 (예: "doorClosed")
  name: string;                      // 표시명 (예: "도어 닫힘")
  pmcKey: string;                    // pmcMap.interlock의 키 참조
  required: boolean;                 // true: 필수 조건 (항상 체크)
  description: string;               // 조건 설명
}

// ※ 인터록 설정 정책
// - 모든 인터록 조건은 Template에서만 정의
// - 일반 사용자/관리자는 인터록 조건 확인만 가능 (수정 불가)
// - AS 담당자만 Template 수정을 통해 인터록 변경 가능
// - 이를 통해 안전 관련 설정의 무단 변경 방지
```

### 4.3 템플릿 적용 흐름

```
1. AS 담당자가 템플릿 생성/등록
   └─→ 기종별 PMC 주소 조사 → 템플릿 정의

2. 관리자가 Machine에 템플릿 할당
   └─→ Machine Settings에서 templateId 지정

3. Agent 시작 시 템플릿 로드
   └─→ Server에서 해당 Machine의 템플릿 정보 수신

4. Agent가 논리명으로 데이터 요청
   └─→ "doorClosed" 요청 → 템플릿에서 X12.5 주소 획득 → FOCAS 호출

5. 데이터 추상화하여 Server로 전송
   └─→ { "doorClosed": true, ... } (PMC 주소 노출 없음)
```

### 4.4 템플릿 버전 관리

**정책**:
- 템플릿 수정 시 새 버전 생성 (기존 버전 유지)
- Machine은 특정 버전에 고정되어 있음
- 버전 업그레이드는 관리자가 명시적으로 수행

**버전 호환성**:
```
v1.0.0 (원본)
  ↓
v1.1.0 (PMC 주소 추가 - 하위 호환)
  ↓
v2.0.0 (PMC 주소 변경 - 하위 비호환)
```

---

## 5. 데이터 흐름

### 5.1 실시간 모니터링 데이터 흐름

```
CNC Controller
     │
     │ FOCAS2 API (100~500ms 주기)
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Field Agent                                                          │
│ 1. FOCAS 함수 호출 (cnc_rdactpt, cnc_statinfo, cnc_rdpmcrng 등)     │
│ 2. 템플릿 기반 데이터 추상화                                         │
│ 3. JSON 메시지 구성                                                  │
└─────────────────────────────────────────────────────────────────────┘
     │
     │ MQTT Publish (Topic: machines/{machineId}/status)
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Central Server                                                       │
│ 1. MQTT Subscribe로 메시지 수신                                      │
│ 2. 데이터 가공/캐싱                                                  │
│ 3. 필요 시 DB 저장 (이력)                                            │
└─────────────────────────────────────────────────────────────────────┘
     │
     │ WebSocket Push
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Web Frontend                                                         │
│ 1. WebSocket 메시지 수신                                             │
│ 2. Zustand Store 업데이트                                            │
│ 3. React 컴포넌트 리렌더링                                           │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 명령 전송 데이터 흐름

```
Web Frontend (관리자)
     │
     │ REST API POST /api/machines/{id}/command
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Central Server                                                       │
│ 1. 인증/인가 확인                                                    │
│ 2. 명령 유효성 검증                                                  │
│ 3. 명령 큐 등록                                                      │
└─────────────────────────────────────────────────────────────────────┘
     │
     │ MQTT Publish (Topic: machines/{machineId}/command)
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Field Agent                                                          │
│ 1. MQTT Subscribe로 명령 수신                                        │
│ 2. 인터록 조건 검증 (템플릿 기반 PMC 확인)                           │
│ 3. 조건 충족 시 FOCAS 함수 호출                                      │
│ 4. 실행 결과 응답                                                    │
└─────────────────────────────────────────────────────────────────────┘
     │
     │ FOCAS2 API
     ▼
CNC Controller
```

### 5.3 주요 데이터 항목

**실시간 수집 데이터**:
| 분류 | 항목 | FOCAS 함수 | 주기 |
|------|------|------------|------|
| 좌표 | 절대/기계/상대 좌표 | cnc_absolute, cnc_machine, cnc_relative | 100ms |
| 상태 | 운전 모드, 알람 | cnc_statinfo | 200ms |
| 스핀들 | RPM, 부하율 | cnc_rdspeed, cnc_rdspload | 200ms |
| 프로그램 | 실행 프로그램명, 블록 | cnc_rdprgnum, cnc_rdexecprog | 500ms |
| 카운터 | 부품 수량 | PMC 읽기 | 1000ms |
| 인터록 | 도어, 척, 스핀들 등 | PMC 읽기 | 200ms |

---

## 6. 스케줄러 실행 흐름

### 6.1 스케줄러 개요
**목적**: 프로그램 순차 실행 자동화 (자동선반)

**핵심 특징**:
- 10~20개 항목의 실행 대기열
- 위에서 아래로 순차 실행
- 사이클 완료 감지 (FOCAS M30 신호)
- 인터록 위반 시 자동 정지

### 6.2 FOCAS 통신 지속성 정책 (화면 전환과 무관)

**아키텍처 원칙**:
- 스케줄러는 FOCAS 기반으로 동작하며, **사용자 화면 이동과 무관하게 동작 지속**
- FOCAS 통신/실행 루프는 **UI가 아니라 Field Agent(백엔드/에이전트)에서 유지**
- UI는 WebSocket을 통해 **상태를 구독하여 표시만** 수행

```
┌─────────────────────────────────────────────────────────────────────┐
│ Field Agent (장비당 1개)                                              │
│ ─────────────────────────────────────────────────────────────────── │
│ │ 스케줄러 실행 루프 │ ← UI와 독립적으로 동작                    │
│ │ FOCAS 통신 루프   │ ← 화면 전환과 무관하게 지속                  │
│ │ 인터록 감시       │ ← 200ms 주기로 지속 감시                   │
│ └──────────────────┘                                               │
│              │                                                      │
│              ▼ MQTT (상태 보고)                                       │
└─────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Central Server                                                       │
│              │ WebSocket으로 상태 Push                                  │
└─────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Web Frontend (스케줄러 UI)                                           │
│ ─────────────────────────────────────────────────────────────────── │
│ · 상태 표시만 수행 (WebSocket 구독)                                  │
│ · 화면 이동 시에도 Agent의 스케줄러는 계속 동작                      │
│ · 다시 스케줄러 화면으로 돌아오면 현재 상태 표시                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 스케줄러 UI 레이아웃 (2분할)

```
┌─────────────────────────────────────────────────────────────────────┐
│ [도어] [척] [스핀들] [쿨런트]              ← 인터록 상태 바 (상단) │
├─────────────────────────────┬───────────────────────────────────────┤
│                             │                                       │
│  [좌측: CNC 모니터 & 조작반]│  [우측: 스케줄러 테이블 영역]         │
│  ─────────────────────      │  ───────────────────────              │
│  · 프로그램명 / 실행 블록   │  Main PGM / Sub PGM / PRESET / COUNT  │
│  · 좌표계 (절대/기계/상대)  │  / 상태 / X (삭제 버튼)               │
│  · 스핀들 RPM / Load        │  ─────────────────────────────────────│
│  · 모달 정보 / 이송 속도    │  O0001 / O0100 / 100 / 50 / Running / X│
│  ─────────────────────      │  O0002 / -     / 50  / 0  / Ready   / X│
│  · 운전 모드 선택 패널      │  O0003 / O0105 / 200 / 0  / Ready   / X│
│    (EDIT, MEM, MDI 등)      │  ...                                  │
│                             │  ─────────────────────────────────────│
│                             │  [시작] [정지] [리셋]                 │
│                             │                                       │
└─────────────────────────────┴───────────────────────────────────────┘
```

### 6.3 스케줄러 테이블 구조 및 동작

**컬럼 순서**: `Main PGM` / `Sub PGM` / `PRESET` / `COUNT` / `Status(상태)` / `X(삭제)`

| 컬럼 | 설명 |
|------|------|
| Main PGM | 메인 가공 프로그램 번호 |
| Sub PGM | 서브 프로그램 번호 (없을 시 '-') |
| PRESET | 프리셋 수량 (목표 목표량) |
| COUNT | 현재 가공 완료 수량 |
| Status | 상태 (Ready, Running, Completed, Error) |
| X (Delete) | 행 삭제 버튼 |

**삭제 행위 (Row Deletion)**:
- 사용자가 `X` 버튼을 클릭하면 해당 행(Row)을 대기열에서 **즉시 제거**
- 제거된 자리는 **하단의 행들이 위로 이동**하며 자동으로 채움
- 실행 중인 행이 삭제되는 경우, 스케줄러는 즉시 중단되거나 다음 행으로 넘어가는 정책에 따름 (기본은 안전을 위해 정지)

### 6.4 스케줄러 실행 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                        스케줄러 시작 요청                            │
│                     (관리자가 [시작] 클릭)                           │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    1. 인터록 조건 전체 확인                          │
│                 (도어, 척, 스핀들 등)                                │
│                      모든 조건 AND 로직                              │
└─────────────────────────────────────────────────────────────────────┘
                          │                    │
                    [조건 충족]           [조건 불충족]
                          │                    │
                          ▼                    ▼
┌─────────────────────────────┐    ┌─────────────────────────────────┐
│  2. 첫 번째 항목 실행        │    │  스케줄러 시작 거부              │
│  - Main PGM 선택            │    │  - 불충족 조건 표시              │
│  - FOCAS 사이클 스타트      │    │  - 사용자에게 알림               │
└─────────────────────────────┘    └─────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    3. 사이클 실행 모니터링                           │
│              - 인터록 조건 지속 감시 (200ms 주기)                    │
│              - 사이클 완료 신호 대기 (M30)                           │
└─────────────────────────────────────────────────────────────────────┘
           │                    │                    │
     [사이클 완료]        [인터록 위반]          [정지 요청]
           │                    │                    │
           ▼                    ▼                    ▼
┌─────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│ 4. COUNT 증가   │  │ 원격 제어 시퀀스 중단 │  │ 1사이클 완료 후 정지│
│ PRESET 도달?    │  │ (인터록 위반 발생)  │  │ (수동 중지)         │
└─────────────────┘  │ ───────────────     │  └─────────────────────┘
      │      │       │ **즉시 FOCAS 명령**   │
   [Yes]  [No]       │ **전송 중단**         │
      │      │       │ - 원격 조작 불가 상태 │
      ▼      └─────────────┐ - 현장 조작 우선권 전환 │
┌─────────────────┐        │ - 알람 기록/사용자 알림│
│ 5. 다음 항목으로│        │ └─────────────────────┘
│ (리스트 없으면  │        │
│  스케줄러 종료) │        │
└─────────────────┘        │
      │                    │
      └────────────────────┤
                           ▼
                    [3번으로 반복]
```

### 6.5 스케줄러 제어 버튼

| 버튼 | 동작 | 비고 |
|------|------|------|
| 시작 | 스케줄러 실행 시작 | 인터록 확인 후 실행 |
| 정지 | 현재 사이클 완료 후 정지 | FOCAS 1사이클 정지 신호 |
| 리셋 | 대기열 전체 초기화 | 확인 팝업 후 실행 |
| 삭제 | 선택 항목 삭제 | 항상 표시, 확인 팝업 |

---

## 7. Transfer 기능의 위치와 역할

### 7.1 Transfer 기능 개요

**목적**: CNC 프로그램 및 데이터의 입출력/백업 관리

**스케줄러와의 관계**:
- Transfer는 별도 메뉴로 분리
- **스케줄러와 동시 동작 가능** (FOCAS API 레벨에서 충돌 없음)
- 스케줄러: 프로그램 실행, 카운트 집계, 순차 진행
- Transfer: 프로그램 입출력, 데이터 백업 (읽기 위주 작업)

**제어권과의 관계**:
- Transfer는 **제어권(원격제어 허가) 없이도 수행 가능**
- 단, 관리자/AS 권한은 필요
- 제어권이 필요한 작업(스케줄러 제어)과 독립적으로 수행 가능

**가동 중 제한 정책**:
| 장비 상태 | 허용 작업 | 제한 작업 |
|----------|----------|----------|
| 정지 중 | 모든 작업 | 없음 |
| 가동 중 | **백업만 허용** | INPUT/OUTPUT 제한 |

> **기술 검증 포인트**: '가동 중 백업 허용 범위'는 FANUC/FOCAS 지원 범위를 확인한 후, 문제가 없으면 허용 (검증 필요)

**동시 동작 시 주의사항**:
- 대부분의 Transfer 작업은 읽기 동작이므로 스케줄러와 병행 가능
- 프로그램 INPUT(서버→CNC) 시에는 실행 중인 프로그램과 다른 번호여야 함
- 구현 시 FOCAS API 동시 호출 테스트 필요

### 7.2 Transfer 기능 구성

#### 7.2.1 네트워크 경로 설정
```typescript
interface TransferSettings {
  inputFolder: string;    // 프로그램 입력 폴더 (서버 → CNC)
  outputFolder: string;   // 프로그램 출력 폴더 (CNC → 서버)
  backupFolder: string;   // 백업 저장 폴더
}
```

#### 7.2.2 프로그램 INPUT (서버 → CNC)
- 지정 폴더의 프로그램 파일 목록 표시
- 선택한 프로그램을 CNC로 전송
- FOCAS `cnc_dwnstart3`, `cnc_download3`, `cnc_dwnend3` 사용

#### 7.2.3 프로그램 OUTPUT (CNC → 서버)
- CNC 내 프로그램 목록 조회
- 선택한 프로그램을 서버 폴더로 저장
- FOCAS `cnc_upstart3`, `cnc_upload3`, `cnc_upend3` 사용

#### 7.2.4 전체 백업 (원격 가능)
```
백업 대상:
├── SRAM 데이터
├── 파라미터 (cnc_rdparam)
├── 모든 프로그램
├── OFFSET 데이터
│   ├── 공구 보정 (cnc_rdtofs)
│   └── 워크 좌표계 (cnc_rdwkcdshft)
└── PMC 데이터 (옵션)

백업 결과:
└── backup_YYYYMMDD_HHMMSS.zip
    ├── programs/
    ├── parameters/
    ├── offsets/
    └── manifest.json
```

#### 7.2.5 복원 정책 (원격 불가)

**원격 복원 차단 이유**:
- 복원 작업은 CNC 데이터를 덮어쓰는 위험한 작업
- 원격에서 잘못된 복원 시 장비 손상 또는 안전 문제 발생 가능
- 현장 담당자가 직접 장비 상태를 확인한 후 수행해야 함

**복원 가능 방법**:
- Agent가 설치된 로컬 PC에서 직접 실행
- 또는 현장에서 CNC 컨트롤러 직접 조작

**원격에서 가능한 작업**:
| 작업 | 원격 가능 | 비고 |
|------|-----------|------|
| 전체 백업 | ✅ 가능 | 읽기 작업 |
| 프로그램 INPUT | ✅ 가능 | Transfer 기능 |
| 프로그램 OUTPUT | ✅ 가능 | Transfer 기능 |
| 전체 복원 | ❌ 불가 | 로컬에서만 |
| 파라미터 복원 | ❌ 불가 | 로컬에서만 |
| OFFSET 복원 | ❌ 불가 | 로컬에서만 |

### 7.3 Transfer 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Web Frontend                                  │
│                   Transfer 메뉴 UI                                   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ REST API
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       Central Server                                 │
│           - 파일 시스템 접근 (네트워크 폴더)                         │
│           - 전송 작업 큐 관리                                        │
│           - 백업 파일 압축/관리                                      │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ MQTT
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Field Agent                                   │
│              - FOCAS 파일 전송 API 호출                              │
│              - 파라미터/OFFSET 읽기/쓰기                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ FOCAS2
                                    ▼
                             CNC Controller
```

---

## 8. POP / MES 연계 구조

### 8.1 POP (Point of Production) 기능

**목적**: 생산 실적 데이터 집계 및 분석

#### 8.1.1 집계 단위
- 일간 (Daily)
- 주간 (Weekly)
- 월간 (Monthly)

#### 8.1.2 집계 항목
```typescript
interface ProductionMetrics {
  // 시간 데이터
  runTime: number;           // 가동 시간
  idleTime: number;          // 대기 시간
  alarmTime: number;         // 알람 시간

  // 생산 데이터
  totalParts: number;        // 총 생산량
  goodParts: number;         // 양품 수량
  defectParts: number;       // 불량 수량

  // 계산 지표
  utilization: number;       // 가동률
  oee: number;               // 설비종합효율
  cycleTimeAvg: number;      // 평균 사이클 타임
}
```

#### 8.1.3 POP 대시보드 요소
- **그래프**: 일/주/월별 생산량 추이
- **KPI 카드**: 가동률, OEE, 생산량
- **비교 차트**: 장비별 성과 비교

### 8.2 이력 관리

#### 8.2.1 프로그램 실행 이력
```typescript
interface ProgramHistory {
  id: string;
  machineId: string;
  programNumber: string;
  startTime: Date;
  endTime: Date;
  partsProduced: number;
  status: 'completed' | 'interrupted' | 'error';
  errorCode?: string;
}
```

#### 8.2.2 알람 이력
```typescript
interface AlarmHistory {
  id: string;
  machineId: string;
  alarmNumber: string;
  alarmMessage: string;
  occurredAt: Date;
  clearedAt?: Date;
  duration: number;          // 알람 지속 시간 (초)
  category: 'system' | 'program' | 'servo' | 'pmc';
}
```

### 8.3 MES (Manufacturing Execution System) 연계

#### 8.3.1 작업지시 관리
```typescript
interface WorkOrder {
  id: string;
  orderNumber: string;       // 작업지시 번호
  productCode: string;       // 제품 코드
  targetQuantity: number;    // 목표 수량
  producedQuantity: number;  // 생산 수량
  assignedMachine: string;   // 배정 장비
  programNumber: string;     // 사용 프로그램
  priority: number;          // 우선순위
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';
  scheduledStart: Date;
  scheduledEnd: Date;
  actualStart?: Date;
  actualEnd?: Date;
}
```

#### 8.3.2 추적성 (Traceability)
- 작업지시 → 프로그램 실행 → 생산 실적 연계
- LOT 번호 기반 추적
- 품질 데이터 연계 (향후 확장)

### 8.4 POP/MES 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                     실시간 생산 데이터                               │
│              (Agent → Server → WebSocket → Frontend)                 │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 이벤트 발생 시 저장
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Database                                     │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │
│  │ program_logs  │  │ alarm_logs    │  │ work_orders   │           │
│  └───────────────┘  └───────────────┘  └───────────────┘           │
│  ┌───────────────┐  ┌───────────────┐                              │
│  │ production_   │  │ machine_      │                              │
│  │ metrics       │  │ states        │                              │
│  └───────────────┘  └───────────────┘                              │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 집계 쿼리 / API
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   POP/MES 분석 화면                                  │
│            (일/주/월 집계, 그래프, 작업지시 관리)                    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 9. 확장성 및 안전성 설계

### 9.1 확장성 설계

#### 9.1.1 수평 확장 (장비 추가)
- **Agent 독립 배치**: 장비당 1 Agent, 장비 추가 시 Agent만 추가
- **템플릿 재사용**: 동일 기종은 기존 템플릿 할당
- **동적 등록**: 새 장비 등록 시 실시간 반영

```
현재: 10대 운영
┌────────┐ ┌────────┐     ┌────────┐
│Agent 1 │ │Agent 2 │ ... │Agent 10│
└────────┘ └────────┘     └────────┘
     │          │              │
     └──────────┴──────────────┘
                │
         Central Server

확장: 20대 운영 (서버 변경 없음)
┌────────┐ ┌────────┐     ┌─────────┐
│Agent 1 │ │Agent 2 │ ... │Agent 20 │
└────────┘ └────────┘     └─────────┘
     │          │              │
     └──────────┴──────────────┘
                │
         Central Server (동일)
```

#### 9.1.2 기능 확장 (새 기종 지원)
- 새 템플릿 생성으로 신규 기종 지원
- 기존 코드 수정 없이 PMC 매핑만 추가
- AS 담당자가 독립적으로 템플릿 관리

#### 9.1.3 성능 확장
- MQTT Broker 클러스터링 (장비 100대+ 대응)
- Redis 캐싱 레이어 추가
- WebSocket 서버 로드밸런싱

### 9.2 안전성 설계

#### 9.2.1 인터록 시스템
**원칙**: 모든 인터록 조건 충족 시에만 동작 허용 (AND 로직)

```typescript
interface InterlockCheck {
  condition: string;
  required: boolean;
  currentValue: boolean;
  passed: boolean;
}

// 인터록 검증 결과 예시
{
  "allPassed": false,
  "checks": [
    { "condition": "doorClosed",     "required": true,  "currentValue": true,  "passed": true  },
    { "condition": "chuckClamped",   "required": true,  "currentValue": true,  "passed": true  },
    { "condition": "spindleStopped", "required": true,  "currentValue": false, "passed": false }
  ],
  "blockedBy": ["spindleStopped"]
}
```

#### 9.2.2 명령 검증 체인
```
사용자 명령 요청
       │
       ▼
┌──────────────────┐
│ 1. 인증 확인     │  → 실패 시: 401 Unauthorized
└──────────────────┘
       │
       ▼
┌──────────────────┐
│ 2. 권한 확인     │  → 실패 시: 403 Forbidden
└──────────────────┘
       │
       ▼
┌──────────────────┐
│ 3. 명령 유효성   │  → 실패 시: 400 Bad Request
└──────────────────┘
       │
       ▼
┌──────────────────┐
│ 4. 인터록 확인   │  → 실패 시: 409 Conflict + 상세 사유
└──────────────────┘
       │
       ▼
┌──────────────────┐
│ 5. 명령 실행     │
└──────────────────┘
```

#### 9.2.3 실패 대응 전략

| 상황 | 대응 |
|------|------|
| Agent 연결 끊김 | 해당 장비 상태 "Offline" 표시, 명령 불가 |
| FOCAS 통신 오류 | 재시도 후 실패 시 알림 발생 |
| 인터록 위반 감지 | **원격 제어 시퀀스 즉시 중단**, FOCAS 명령 전송 금지, 현장 우선 모드 전환 |
| 서버 다운 | Agent 독립 동작 (로컬 캐싱), 복구 후 동기화 |

#### 9.2.4 감사 로그 (Audit Log)
```typescript
interface AuditLog {
  id: string;
  timestamp: Date;
  userId: string;
  userRole: 'user' | 'admin' | 'as';
  action: string;              // 예: "scheduler.start", "control.request", "transfer.upload"
  targetMachine?: string;
  parameters: object;
  result: 'success' | 'failure';
  errorMessage?: string;
  ipAddress: string;
}
```

제어 명령, 설정 변경, **제어권 획득/반납** 이력이 감사 로그에 기록됨

### 9.3 제어권 (원격제어 허가) 정책

**목적**: 다중 관리자 접속 환경에서 동시 제어로 인한 장비 오동작 및 데이터 충돌 방지

#### 9.3.1 기본 원칙
- **장비 단위(machineId) 독점 제어**: 제어권은 장비별로 단 1개만 존재
- **선 승인 후 조작**: 제어 명령(스케줄러 시작/정지/리셋, 설정 저장 등) 실행 전에 반드시 "제어실행요청"을 통해 제어권을 먼저 획득해야 함
- **인터록 연동**: 제어권 요청은 시스템의 모든 인터록 조건이 만족될 때만 승인됨

#### 9.3.2 제어권 획득 및 표시
- **획득 방법**: UI 우측 상단의 "제어실행요청" 버튼 클릭
- **제어자 표시**:
  - 현재 제어자가 없는 경우: "제어 요청 가능" 상태 표시
  - 이미 제어자가 있는 경우: "현재 제어자: [사용자ID]" 표시 및 다른 관리자의 요청 제한
- **승인 실패**: 인터록 조건 불충족 시 실패 사유(막고 있는 인터록 항목)를 UI에 표시

#### 9.3.3 제어권 종료(반납) 조건
1. **사용자 명시 종료**: "제어 종료" 버튼을 눌러 수동 반납
2. **연결 해제**: 브라우저 종료, 네트워크 단절 등으로 연결이 끊긴 경우 (Heartbeat/Lease 만료 처리)
3. **유휴 시간 초과 (Idle Timeout)**: 일정 시간(예: 5분) 동안 제어/설정 API 호출이 없는 경우 자동 종료
   - ※ 단순 화면 이동은 조작으로 간주하지 않음 (실제 제어 API 호출 기준)

#### 9.3.4 제어권과 기능 간 관계
- **제어권 필수**: 스케줄러 조작(시작/정지/리셋/삭제), 장비 설정 변경, 명령 전송
- **제어권 불필요**: 모니터링 조회, POP/MES 조회, Transfer(프로그램 입출력/백업)

---

## 10. 현재 아키텍처의 전제와 남은 검토 포인트

### 10.1 현재 아키텍처 전제 조건

#### 기술적 전제
| 전제 | 설명 | 위험도 |
|------|------|--------|
| FOCAS2 사용 가능 | 모든 대상 장비가 FOCAS2 지원 CNC | 낮음 |
| Ethernet 연결 | CNC-Agent 간 이더넷 통신 가능 | 낮음 |
| Windows 환경 | Agent가 Windows에서 동작 (FOCAS DLL) | 중간 |
| 네트워크 안정성 | 공장 내부 네트워크 안정적 | 중간 |

#### 운영적 전제
| 전제 | 설명 | 위험도 |
|------|------|--------|
| 관리자 상주 | 스케줄러 운영 시 관리자 모니터링 | 낮음 |
| PMC 주소 정보 | 기종별 PMC 주소 문서 확보 | 중간 |
| AS 담당자 역량 | 템플릿 생성/수정 가능한 인력 | 중간 |

### 10.2 남은 검토 포인트

#### 10.2.1 기술 검토 필요 항목

| 항목 | 질문 | 결정 필요 시점 |
|------|------|----------------|
| 인증 방식 | JWT vs Session? OAuth 연동 필요? | 개발 초기 |
| 데이터베이스 | PostgreSQL vs MySQL? TimescaleDB 필요? | 개발 초기 |
| 캐싱 전략 | Redis 사용 여부, 캐시 무효화 전략 | 개발 중기 |
| 메시지 큐 | MQTT 외 추가 큐 필요? (대량 이력 저장) | 개발 중기 |
| 파일 저장 | 로컬 vs NAS vs 클라우드 스토리지 | 개발 초기 |

#### 10.2.2 UI/UX 검토 필요 항목

| 항목 | 질문 | 결정 필요 시점 |
|------|------|----------------|
| 3D 뷰어 | 라이브러리 선정 (Three.js, Babylon.js 등) | 개발 중기 |
| 차트 라이브러리 | Recharts vs Chart.js vs D3.js | 개발 초기 |
| 반응형 지원 | 태블릿/모바일 지원 범위 | 개발 초기 |
| 다국어 지원 | i18n 필요 여부 | 개발 후기 |

#### 10.2.3 보안 검토 필요 항목

| 항목 | 질문 | 결정 필요 시점 |
|------|------|----------------|
| 네트워크 분리 | OT/IT 네트워크 분리 전략 | 설계 시 |
| 암호화 | 통신 암호화 범위 (MQTT TLS, HTTPS) | 개발 초기 |
| 접근 제어 | IP 화이트리스트, VPN 필요 여부 | 배포 시 |
| 취약점 점검 | 보안 감사 일정 | 배포 전 |

#### 10.2.4 운영 검토 필요 항목

| 항목 | 질문 | 결정 필요 시점 |
|------|------|----------------|
| 배포 환경 | On-premise vs 클라우드 vs 하이브리드 | 설계 시 |
| 모니터링 | Prometheus + Grafana vs 상용 APM | 개발 후기 |
| 백업 정책 | DB 백업 주기, 보관 기간 | 배포 시 |
| 장애 복구 | RTO/RPO 목표, DR 전략 | 배포 시 |

### 10.3 Phase별 구현 계획 (제안)

#### Phase 1: 기반 구축
- 프로젝트 구조 설정
- 기본 통신 레이어 구현 (REST, WebSocket, MQTT)
- 인증/인가 시스템
- 기본 DB 스키마

#### Phase 2: 핵심 기능
- 실시간 모니터링 (대시보드 2D)
- 장비 상태 표시
- 기본 알람 관리
- 템플릿 시스템 (1개 기종)

#### Phase 3: 스케줄러
- 스케줄러 UI
- 인터록 시스템
- 사이클 카운팅
- 스케줄러 제어 로직

#### Phase 4: Transfer & POP
- 프로그램 전송 (INPUT/OUTPUT)
- 백업 기능
- POP 집계
- 이력 조회

#### Phase 5: 고급 기능
- 대시보드 3D
- MES 연계
- 다중 템플릿
- 성능 최적화

---

## 문서 정보

- **문서 버전**: 1.5
- **작성일**: 2026-01-22
- **최종 수정일**: 2026-01-23
- **목적**: 설계 검증 및 아키텍처 리뷰용 (변경사항 확정본)
- **대상 독자**: 개발팀, 프로젝트 관리자, 기술 검토자

### 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|:---:|-----------|
| 1.0 | 2026-01-22 | 초안 작성 |
| 1.1 | 2026-01-22 | 아키텍처 리뷰 반영 (인터록, 캐싱, 동시실행, API 표준 등) |
| 1.2 | 2026-01-22 | 메뉴 접속도 및 권한표 추가 |
| 1.3 | 2026-01-23 | 추가 확정 사항 반영 (호기 컨텍스트, 제어권 정책 등) |
| 1.4 | 2026-01-23 | UI 레이아웃 및 안전 시퀀스 강화 |
| 1.5 | 2026-01-23 | **바피더(Bar Feeder) 연동 제외 적용** <br> - 대상 장비 및 프로젝트 목적 수정 <br> - UI 인터록 바 및 템플릿 데이터 구조에서 바피더 관련 항목 제거 |

---

*이 문서는 CNC 자동선반 스마트팩토리 시스템의 아키텍처 설계를 검증하기 위한 목적으로 작성되었습니다. 구현 전 각 섹션의 내용을 검토하고 미결정 사항에 대한 의사결정을 진행해야 합니다.*
